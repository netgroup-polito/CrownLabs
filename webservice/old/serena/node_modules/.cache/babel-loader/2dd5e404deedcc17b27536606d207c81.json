{"ast":null,"code":"// much of this based on https://github.com/indutny/self-signed/blob/gh-pages/lib/rsa.js\nvar createHmac = require('create-hmac');\n\nvar crt = require('browserify-rsa');\n\nvar EC = require('elliptic').ec;\n\nvar BN = require('bn.js');\n\nvar parseKeys = require('parse-asn1');\n\nvar curves = require('./curves.json');\n\nfunction sign(hash, key, hashType, signType, tag) {\n  var priv = parseKeys(key);\n\n  if (priv.curve) {\n    // rsa keys can be interpreted as ecdsa ones in openssl\n    if (signType !== 'ecdsa' && signType !== 'ecdsa/rsa') throw new Error('wrong private key type');\n    return ecSign(hash, priv);\n  } else if (priv.type === 'dsa') {\n    if (signType !== 'dsa') throw new Error('wrong private key type');\n    return dsaSign(hash, priv, hashType);\n  } else {\n    if (signType !== 'rsa' && signType !== 'ecdsa/rsa') throw new Error('wrong private key type');\n  }\n\n  hash = Buffer.concat([tag, hash]);\n  var len = priv.modulus.byteLength();\n  var pad = [0, 1];\n\n  while (hash.length + pad.length + 1 < len) pad.push(0xff);\n\n  pad.push(0x00);\n  var i = -1;\n\n  while (++i < hash.length) pad.push(hash[i]);\n\n  var out = crt(pad, priv);\n  return out;\n}\n\nfunction ecSign(hash, priv) {\n  var curveId = curves[priv.curve.join('.')];\n  if (!curveId) throw new Error('unknown curve ' + priv.curve.join('.'));\n  var curve = new EC(curveId);\n  var key = curve.keyFromPrivate(priv.privateKey);\n  var out = key.sign(hash);\n  return new Buffer(out.toDER());\n}\n\nfunction dsaSign(hash, priv, algo) {\n  var x = priv.params.priv_key;\n  var p = priv.params.p;\n  var q = priv.params.q;\n  var g = priv.params.g;\n  var r = new BN(0);\n  var k;\n  var H = bits2int(hash, q).mod(q);\n  var s = false;\n  var kv = getKey(x, q, hash, algo);\n\n  while (s === false) {\n    k = makeKey(q, kv, algo);\n    r = makeR(g, k, p, q);\n    s = k.invm(q).imul(H.add(x.mul(r))).mod(q);\n\n    if (s.cmpn(0) === 0) {\n      s = false;\n      r = new BN(0);\n    }\n  }\n\n  return toDER(r, s);\n}\n\nfunction toDER(r, s) {\n  r = r.toArray();\n  s = s.toArray(); // Pad values\n\n  if (r[0] & 0x80) r = [0].concat(r);\n  if (s[0] & 0x80) s = [0].concat(s);\n  var total = r.length + s.length + 4;\n  var res = [0x30, total, 0x02, r.length];\n  res = res.concat(r, [0x02, s.length], s);\n  return new Buffer(res);\n}\n\nfunction getKey(x, q, hash, algo) {\n  x = new Buffer(x.toArray());\n\n  if (x.length < q.byteLength()) {\n    var zeros = new Buffer(q.byteLength() - x.length);\n    zeros.fill(0);\n    x = Buffer.concat([zeros, x]);\n  }\n\n  var hlen = hash.length;\n  var hbits = bits2octets(hash, q);\n  var v = new Buffer(hlen);\n  v.fill(1);\n  var k = new Buffer(hlen);\n  k.fill(0);\n  k = createHmac(algo, k).update(v).update(new Buffer([0])).update(x).update(hbits).digest();\n  v = createHmac(algo, k).update(v).digest();\n  k = createHmac(algo, k).update(v).update(new Buffer([1])).update(x).update(hbits).digest();\n  v = createHmac(algo, k).update(v).digest();\n  return {\n    k: k,\n    v: v\n  };\n}\n\nfunction bits2int(obits, q) {\n  var bits = new BN(obits);\n  var shift = (obits.length << 3) - q.bitLength();\n  if (shift > 0) bits.ishrn(shift);\n  return bits;\n}\n\nfunction bits2octets(bits, q) {\n  bits = bits2int(bits, q);\n  bits = bits.mod(q);\n  var out = new Buffer(bits.toArray());\n\n  if (out.length < q.byteLength()) {\n    var zeros = new Buffer(q.byteLength() - out.length);\n    zeros.fill(0);\n    out = Buffer.concat([zeros, out]);\n  }\n\n  return out;\n}\n\nfunction makeKey(q, kv, algo) {\n  var t;\n  var k;\n\n  do {\n    t = new Buffer(0);\n\n    while (t.length * 8 < q.bitLength()) {\n      kv.v = createHmac(algo, kv.k).update(kv.v).digest();\n      t = Buffer.concat([t, kv.v]);\n    }\n\n    k = bits2int(t, q);\n    kv.k = createHmac(algo, kv.k).update(kv.v).update(new Buffer([0])).digest();\n    kv.v = createHmac(algo, kv.k).update(kv.v).digest();\n  } while (k.cmp(q) !== -1);\n\n  return k;\n}\n\nfunction makeR(g, k, p, q) {\n  return g.toRed(BN.mont(p)).redPow(k).fromRed().mod(q);\n}\n\nmodule.exports = sign;\nmodule.exports.getKey = getKey;\nmodule.exports.makeKey = makeKey;","map":{"version":3,"sources":["/home/s41m0n/Documents/University/Turin/YearII/CrownLabs/frontend/node_modules/browserify-sign/browser/sign.js"],"names":["createHmac","require","crt","EC","ec","BN","parseKeys","curves","sign","hash","key","hashType","signType","tag","priv","curve","Error","ecSign","type","dsaSign","Buffer","concat","len","modulus","byteLength","pad","length","push","i","out","curveId","join","keyFromPrivate","privateKey","toDER","algo","x","params","priv_key","p","q","g","r","k","H","bits2int","mod","s","kv","getKey","makeKey","makeR","invm","imul","add","mul","cmpn","toArray","total","res","zeros","fill","hlen","hbits","bits2octets","v","update","digest","obits","bits","shift","bitLength","ishrn","t","cmp","toRed","mont","redPow","fromRed","module","exports"],"mappings":"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","sourcesContent":["// much of this based on https://github.com/indutny/self-signed/blob/gh-pages/lib/rsa.js\nvar createHmac = require('create-hmac')\nvar crt = require('browserify-rsa')\nvar EC = require('elliptic').ec\nvar BN = require('bn.js')\nvar parseKeys = require('parse-asn1')\nvar curves = require('./curves.json')\n\nfunction sign (hash, key, hashType, signType, tag) {\n  var priv = parseKeys(key)\n  if (priv.curve) {\n    // rsa keys can be interpreted as ecdsa ones in openssl\n    if (signType !== 'ecdsa' && signType !== 'ecdsa/rsa') throw new Error('wrong private key type')\n    return ecSign(hash, priv)\n  } else if (priv.type === 'dsa') {\n    if (signType !== 'dsa') throw new Error('wrong private key type')\n    return dsaSign(hash, priv, hashType)\n  } else {\n    if (signType !== 'rsa' && signType !== 'ecdsa/rsa') throw new Error('wrong private key type')\n  }\n  hash = Buffer.concat([tag, hash])\n  var len = priv.modulus.byteLength()\n  var pad = [ 0, 1 ]\n  while (hash.length + pad.length + 1 < len) pad.push(0xff)\n  pad.push(0x00)\n  var i = -1\n  while (++i < hash.length) pad.push(hash[i])\n\n  var out = crt(pad, priv)\n  return out\n}\n\nfunction ecSign (hash, priv) {\n  var curveId = curves[priv.curve.join('.')]\n  if (!curveId) throw new Error('unknown curve ' + priv.curve.join('.'))\n\n  var curve = new EC(curveId)\n  var key = curve.keyFromPrivate(priv.privateKey)\n  var out = key.sign(hash)\n\n  return new Buffer(out.toDER())\n}\n\nfunction dsaSign (hash, priv, algo) {\n  var x = priv.params.priv_key\n  var p = priv.params.p\n  var q = priv.params.q\n  var g = priv.params.g\n  var r = new BN(0)\n  var k\n  var H = bits2int(hash, q).mod(q)\n  var s = false\n  var kv = getKey(x, q, hash, algo)\n  while (s === false) {\n    k = makeKey(q, kv, algo)\n    r = makeR(g, k, p, q)\n    s = k.invm(q).imul(H.add(x.mul(r))).mod(q)\n    if (s.cmpn(0) === 0) {\n      s = false\n      r = new BN(0)\n    }\n  }\n  return toDER(r, s)\n}\n\nfunction toDER (r, s) {\n  r = r.toArray()\n  s = s.toArray()\n\n  // Pad values\n  if (r[0] & 0x80) r = [ 0 ].concat(r)\n  if (s[0] & 0x80) s = [ 0 ].concat(s)\n\n  var total = r.length + s.length + 4\n  var res = [ 0x30, total, 0x02, r.length ]\n  res = res.concat(r, [ 0x02, s.length ], s)\n  return new Buffer(res)\n}\n\nfunction getKey (x, q, hash, algo) {\n  x = new Buffer(x.toArray())\n  if (x.length < q.byteLength()) {\n    var zeros = new Buffer(q.byteLength() - x.length)\n    zeros.fill(0)\n    x = Buffer.concat([ zeros, x ])\n  }\n  var hlen = hash.length\n  var hbits = bits2octets(hash, q)\n  var v = new Buffer(hlen)\n  v.fill(1)\n  var k = new Buffer(hlen)\n  k.fill(0)\n  k = createHmac(algo, k).update(v).update(new Buffer([ 0 ])).update(x).update(hbits).digest()\n  v = createHmac(algo, k).update(v).digest()\n  k = createHmac(algo, k).update(v).update(new Buffer([ 1 ])).update(x).update(hbits).digest()\n  v = createHmac(algo, k).update(v).digest()\n  return { k: k, v: v }\n}\n\nfunction bits2int (obits, q) {\n  var bits = new BN(obits)\n  var shift = (obits.length << 3) - q.bitLength()\n  if (shift > 0) bits.ishrn(shift)\n  return bits\n}\n\nfunction bits2octets (bits, q) {\n  bits = bits2int(bits, q)\n  bits = bits.mod(q)\n  var out = new Buffer(bits.toArray())\n  if (out.length < q.byteLength()) {\n    var zeros = new Buffer(q.byteLength() - out.length)\n    zeros.fill(0)\n    out = Buffer.concat([ zeros, out ])\n  }\n  return out\n}\n\nfunction makeKey (q, kv, algo) {\n  var t\n  var k\n\n  do {\n    t = new Buffer(0)\n\n    while (t.length * 8 < q.bitLength()) {\n      kv.v = createHmac(algo, kv.k).update(kv.v).digest()\n      t = Buffer.concat([ t, kv.v ])\n    }\n\n    k = bits2int(t, q)\n    kv.k = createHmac(algo, kv.k).update(kv.v).update(new Buffer([ 0 ])).digest()\n    kv.v = createHmac(algo, kv.k).update(kv.v).digest()\n  } while (k.cmp(q) !== -1)\n\n  return k\n}\n\nfunction makeR (g, k, p, q) {\n  return g.toRed(BN.mont(p)).redPow(k).fromRed().mod(q)\n}\n\nmodule.exports = sign\nmodule.exports.getKey = getKey\nmodule.exports.makeKey = makeKey\n"]},"metadata":{},"sourceType":"script"}