{"ast":null,"code":"/*!\n * algorithms/aes-gcm.js - AES-GCM Encryption and Key-Wrapping\n *\n * Copyright (c) 2015 Cisco Systems, Inc.  See LICENSE file.\n */\n\"use strict\";\n\nvar helpers = require(\"./helpers.js\"),\n    util = require(\"../util\"),\n    CONSTANTS = require(\"./constants.js\"),\n    GCM = require(\"../deps/ciphermodes/gcm\");\n\nfunction gcmEncryptFN(size, wrap) {\n  function commonChecks(key, iv) {\n    if (size !== key.length << 3) {\n      throw new Error(\"invalid key size\");\n    }\n\n    if (!iv && !wrap) {\n      throw new Error(\"invalid iv\");\n    }\n\n    if (iv && 12 !== iv.length) {\n      throw new Error(\"invalid iv\");\n    }\n  }\n\n  function prepareResults(results) {\n    if (wrap) {\n      var iv = util.base64url.encode(results.iv);\n      var tag = util.base64url.encode(results.tag);\n      results = {\n        data: results.data,\n        header: {\n          iv: iv,\n          tag: tag\n        }\n      };\n    }\n\n    return results;\n  } // ### 'fallback' implementation -- uses forge\n\n\n  var fallback = function (key, pdata, props) {\n    var iv = props.iv,\n        adata = props.aad || props.adata || Buffer.alloc(0),\n        cipher,\n        cdata; // validate inputs\n\n    try {\n      commonChecks(key, iv, adata);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    iv = iv || util.randomBytes(12); // setup cipher\n\n    cipher = GCM.createCipher({\n      key: key,\n      iv: iv,\n      additionalData: adata\n    }); // ciphertext is the same length as plaintext\n\n    cdata = Buffer.alloc(pdata.length);\n    var promise = new Promise(function (resolve, reject) {\n      var amt = CONSTANTS.CHUNK_SIZE,\n          clen = 0,\n          poff = 0;\n\n      (function doChunk() {\n        var plen = Math.min(amt, pdata.length - poff);\n        clen += cipher.update(pdata, poff, plen, cdata, clen);\n        poff += plen;\n\n        if (pdata.length > poff) {\n          setTimeout(doChunk, 0);\n          return;\n        } // finish it\n\n\n        clen += cipher.finish(cdata, clen);\n\n        if (clen !== pdata.length) {\n          reject(new Error(\"encryption failed\"));\n          return;\n        } // resolve with output\n\n\n        var tag = cipher.tag;\n        resolve(prepareResults({\n          data: cdata,\n          iv: iv,\n          tag: tag\n        }));\n      })();\n    });\n    return promise;\n  }; // ### WebCryptoAPI implementation\n  // TODO: cache CryptoKey sooner\n\n\n  var webcrypto = function (key, pdata, props) {\n    var iv = props.iv,\n        adata = props.aad || props.adata || Buffer.alloc(0);\n\n    try {\n      commonChecks(key, iv, adata);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    iv = iv || util.randomBytes(12);\n    var alg = {\n      name: \"AES-GCM\"\n    };\n    var promise;\n    promise = helpers.subtleCrypto.importKey(\"raw\", key, alg, true, [\"encrypt\"]);\n    promise = promise.then(function (key) {\n      alg.iv = iv;\n      alg.tagLength = 128;\n\n      if (adata.length) {\n        alg.additionalData = adata;\n      }\n\n      return helpers.subtleCrypto.encrypt(alg, key, pdata);\n    });\n    promise = promise.then(function (result) {\n      var tagStart = result.byteLength - 16;\n      var tag = result.slice(tagStart);\n      tag = Buffer.from(tag);\n      var cdata = result.slice(0, tagStart);\n      cdata = Buffer.from(cdata);\n      return prepareResults({\n        data: cdata,\n        iv: iv,\n        tag: tag\n      });\n    });\n    return promise;\n  }; // ### NodeJS implementation\n\n\n  var nodejs = function (key, pdata, props) {\n    var iv = props.iv,\n        adata = props.aad || props.adata || Buffer.alloc(0);\n\n    try {\n      commonChecks(key, iv, adata);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    iv = iv || util.randomBytes(12);\n    var alg = \"aes-\" + key.length * 8 + \"-gcm\";\n    var cipher;\n\n    try {\n      cipher = helpers.nodeCrypto.createCipheriv(alg, key, iv);\n    } catch (err) {\n      throw new Error(\"unsupported algorithm: \" + alg);\n    }\n\n    if (\"function\" !== typeof cipher.setAAD) {\n      throw new Error(\"unsupported algorithm: \" + alg);\n    }\n\n    if (adata.length) {\n      cipher.setAAD(adata);\n    }\n\n    var cdata = Buffer.concat([cipher.update(pdata), cipher.final()]);\n    var tag = cipher.getAuthTag();\n    return prepareResults({\n      data: cdata,\n      iv: iv,\n      tag: tag\n    });\n  };\n\n  return helpers.setupFallback(nodejs, webcrypto, fallback);\n}\n\nfunction gcmDecryptFN(size) {\n  function commonChecks(key, iv, tag) {\n    if (size !== key.length << 3) {\n      throw new Error(\"invalid key size\");\n    }\n\n    if (12 !== iv.length) {\n      throw new Error(\"invalid iv\");\n    }\n\n    if (16 !== tag.length) {\n      throw new Error(\"invalid tag length\");\n    }\n  } // ### fallback implementation -- uses forge\n\n\n  var fallback = function (key, cdata, props) {\n    var adata = props.aad || props.adata || Buffer.alloc(0),\n        iv = props.iv || Buffer.alloc(0),\n        tag = props.tag || props.mac || Buffer.alloc(0),\n        cipher,\n        pdata; // validate inputs\n\n    try {\n      commonChecks(key, iv, tag);\n    } catch (err) {\n      return Promise.reject(err);\n    } // setup cipher\n\n\n    cipher = GCM.createDecipher({\n      key: key,\n      iv: iv,\n      additionalData: adata,\n      tag: tag\n    }); // plaintext is the same length as ciphertext\n\n    pdata = Buffer.alloc(cdata.length);\n    var promise = new Promise(function (resolve, reject) {\n      var amt = CONSTANTS.CHUNK_SIZE,\n          plen = 0,\n          coff = 0;\n\n      (function doChunk() {\n        var clen = Math.min(amt, cdata.length - coff);\n        plen += cipher.update(cdata, coff, clen, pdata, plen);\n        coff += clen;\n\n        if (cdata.length > coff) {\n          setTimeout(doChunk, 0);\n          return;\n        }\n\n        try {\n          plen += cipher.finish(pdata, plen);\n        } catch (err) {\n          reject(new Error(\"decryption failed\"));\n          return;\n        }\n\n        if (plen !== cdata.length) {\n          reject(new Error(\"decryption failed\"));\n          return;\n        } // resolve with output\n\n\n        resolve(pdata);\n      })();\n    });\n    return promise;\n  }; // ### WebCryptoAPI implementation\n  // TODO: cache CryptoKey sooner\n\n\n  var webcrypto = function (key, cdata, props) {\n    var adata = props.aad || props.adata || Buffer.alloc(0),\n        iv = props.iv || Buffer.alloc(0),\n        tag = props.tag || props.mac || Buffer.alloc(0); // validate inputs\n\n    try {\n      commonChecks(key, iv, tag);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    var alg = {\n      name: \"AES-GCM\"\n    };\n    var promise;\n    promise = helpers.subtleCrypto.importKey(\"raw\", key, alg, true, [\"decrypt\"]);\n    promise = promise.then(function (key) {\n      alg.iv = iv;\n      alg.tagLength = 128;\n\n      if (adata.length) {\n        alg.additionalData = adata;\n      } // concatenate cdata and tag\n\n\n      cdata = Buffer.concat([cdata, tag], cdata.length + tag.length);\n      return helpers.subtleCrypto.decrypt(alg, key, cdata);\n    });\n    promise = promise.then(function (pdata) {\n      pdata = Buffer.from(pdata);\n      return pdata;\n    });\n    return promise;\n  };\n\n  var nodejs = function (key, cdata, props) {\n    var adata = props.aad || props.adata || Buffer.alloc(0),\n        iv = props.iv || Buffer.alloc(0),\n        tag = props.tag || props.mac || Buffer.alloc(0); // validate inputs\n\n    try {\n      commonChecks(key, iv, tag);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    var alg = \"aes-\" + key.length * 8 + \"-gcm\";\n    var cipher;\n\n    try {\n      cipher = helpers.nodeCrypto.createDecipheriv(alg, key, iv);\n    } catch (err) {\n      throw new Error(\"unsupported algorithm: \" + alg);\n    }\n\n    if (\"function\" !== typeof cipher.setAAD) {\n      throw new Error(\"unsupported algorithm: \" + alg);\n    }\n\n    cipher.setAuthTag(tag);\n\n    if (adata.length) {\n      cipher.setAAD(adata);\n    }\n\n    try {\n      var pdata = Buffer.concat([cipher.update(cdata), cipher.final()]);\n      return pdata;\n    } catch (err) {\n      throw new Error(\"decryption failed\");\n    }\n  };\n\n  return helpers.setupFallback(nodejs, webcrypto, fallback);\n} // ### Public API\n// * [name].encrypt\n// * [name].decrypt\n\n\nvar aesGcm = {};\n[\"A128GCM\", \"A192GCM\", \"A256GCM\", \"A128GCMKW\", \"A192GCMKW\", \"A256GCMKW\"].forEach(function (alg) {\n  var parts = /A(\\d+)GCM(KW)?/g.exec(alg);\n  var size = parseInt(parts[1]);\n  var wrap = parts[2] === \"KW\";\n  aesGcm[alg] = {\n    encrypt: gcmEncryptFN(size, wrap),\n    decrypt: gcmDecryptFN(size, wrap)\n  };\n});\nmodule.exports = aesGcm;","map":{"version":3,"sources":["/home/s41m0n/Documents/University/Turin/YearII/CrownLabs/frontend/node_modules/node-jose/lib/algorithms/aes-gcm.js"],"names":["helpers","require","util","CONSTANTS","GCM","gcmEncryptFN","size","wrap","commonChecks","key","iv","length","Error","prepareResults","results","base64url","encode","tag","data","header","fallback","pdata","props","adata","aad","Buffer","alloc","cipher","cdata","err","Promise","reject","randomBytes","createCipher","additionalData","promise","resolve","amt","CHUNK_SIZE","clen","poff","doChunk","plen","Math","min","update","setTimeout","finish","webcrypto","alg","name","subtleCrypto","importKey","then","tagLength","encrypt","result","tagStart","byteLength","slice","from","nodejs","nodeCrypto","createCipheriv","setAAD","concat","final","getAuthTag","setupFallback","gcmDecryptFN","mac","createDecipher","coff","decrypt","createDecipheriv","setAuthTag","aesGcm","forEach","parts","exec","parseInt","module","exports"],"mappings":"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","sourcesContent":["/*!\n * algorithms/aes-gcm.js - AES-GCM Encryption and Key-Wrapping\n *\n * Copyright (c) 2015 Cisco Systems, Inc.  See LICENSE file.\n */\n\"use strict\";\n\nvar helpers = require(\"./helpers.js\"),\n    util = require(\"../util\"),\n    CONSTANTS = require(\"./constants.js\"),\n    GCM = require(\"../deps/ciphermodes/gcm\");\n\nfunction gcmEncryptFN(size, wrap) {\n  function commonChecks(key, iv) {\n    if (size !== (key.length << 3)) {\n       throw new Error(\"invalid key size\");\n    }\n    if (!iv && !wrap) {\n      throw new Error(\"invalid iv\");\n    }\n    if (iv && 12 !== iv.length) {\n      throw new Error(\"invalid iv\");\n    }\n  }\n\n  function prepareResults(results) {\n    if (wrap) {\n      var iv = util.base64url.encode(results.iv);\n      var tag = util.base64url.encode(results.tag);\n\n      results = {\n        data: results.data,\n        header: {\n          iv: iv,\n          tag: tag\n        }\n      };\n    }\n\n    return results;\n  }\n\n  // ### 'fallback' implementation -- uses forge\n  var fallback = function(key, pdata, props) {\n    var iv = props.iv,\n        adata = props.aad || props.adata || Buffer.alloc(0),\n        cipher,\n        cdata;\n\n    // validate inputs\n    try {\n      commonChecks(key, iv, adata);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    iv = iv || util.randomBytes(12);\n\n    // setup cipher\n    cipher = GCM.createCipher({\n      key: key,\n      iv: iv,\n      additionalData: adata\n    });\n    // ciphertext is the same length as plaintext\n    cdata = Buffer.alloc(pdata.length);\n\n    var promise = new Promise(function(resolve, reject) {\n      var amt = CONSTANTS.CHUNK_SIZE,\n          clen = 0,\n          poff = 0;\n\n      (function doChunk() {\n        var plen = Math.min(amt, pdata.length - poff);\n        clen += cipher.update(pdata,\n                              poff,\n                              plen,\n                              cdata,\n                              clen);\n        poff += plen;\n        if (pdata.length > poff) {\n          setTimeout(doChunk, 0);\n          return;\n        }\n\n        // finish it\n        clen += cipher.finish(cdata, clen);\n        if (clen !== pdata.length) {\n          reject(new Error(\"encryption failed\"));\n          return;\n        }\n\n        // resolve with output\n        var tag = cipher.tag;\n        resolve(prepareResults({\n          data: cdata,\n          iv: iv,\n          tag: tag\n        }));\n      })();\n    });\n\n    return promise;\n  };\n\n  // ### WebCryptoAPI implementation\n  // TODO: cache CryptoKey sooner\n  var webcrypto = function(key, pdata, props) {\n    var iv = props.iv,\n        adata = props.aad || props.adata || Buffer.alloc(0);\n\n    try {\n      commonChecks(key, iv, adata);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    iv = iv || util.randomBytes(12);\n\n    var alg = {\n      name: \"AES-GCM\"\n    };\n    var promise;\n    promise = helpers.subtleCrypto.importKey(\"raw\", key, alg, true, [\"encrypt\"]);\n    promise = promise.then(function(key) {\n      alg.iv = iv;\n      alg.tagLength = 128;\n      if (adata.length) {\n        alg.additionalData = adata;\n      }\n\n      return helpers.subtleCrypto.encrypt(alg, key, pdata);\n    });\n    promise = promise.then(function(result) {\n      var tagStart = result.byteLength - 16;\n\n      var tag = result.slice(tagStart);\n      tag = Buffer.from(tag);\n\n      var cdata = result.slice(0, tagStart);\n      cdata = Buffer.from(cdata);\n\n      return prepareResults({\n        data: cdata,\n        iv: iv,\n        tag: tag\n      });\n    });\n\n    return promise;\n  };\n\n  // ### NodeJS implementation\n  var nodejs = function(key, pdata, props) {\n    var iv = props.iv,\n        adata = props.aad || props.adata || Buffer.alloc(0);\n\n    try {\n      commonChecks(key, iv, adata);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    iv = iv || util.randomBytes(12);\n\n    var alg = \"aes-\" + (key.length * 8) + \"-gcm\";\n    var cipher;\n    try {\n      cipher = helpers.nodeCrypto.createCipheriv(alg, key, iv);\n    } catch (err) {\n      throw new Error(\"unsupported algorithm: \" + alg);\n    }\n    if (\"function\" !== typeof cipher.setAAD) {\n      throw new Error(\"unsupported algorithm: \" + alg);\n    }\n    if (adata.length) {\n      cipher.setAAD(adata);\n    }\n\n    var cdata = Buffer.concat([\n      cipher.update(pdata),\n      cipher.final()\n    ]);\n    var tag = cipher.getAuthTag();\n\n    return prepareResults({\n      data: cdata,\n      iv: iv,\n      tag: tag\n    });\n  };\n\n  return helpers.setupFallback(nodejs, webcrypto, fallback);\n}\n\nfunction gcmDecryptFN(size) {\n  function commonChecks(key, iv, tag) {\n    if (size !== (key.length << 3)) {\n      throw new Error(\"invalid key size\");\n    }\n    if (12 !== iv.length) {\n      throw new Error(\"invalid iv\");\n    }\n    if (16 !== tag.length) {\n      throw new Error(\"invalid tag length\");\n    }\n  }\n\n  // ### fallback implementation -- uses forge\n  var fallback = function(key, cdata, props) {\n    var adata = props.aad || props.adata || Buffer.alloc(0),\n        iv = props.iv || Buffer.alloc(0),\n        tag = props.tag || props.mac || Buffer.alloc(0),\n        cipher,\n        pdata;\n\n    // validate inputs\n    try {\n      commonChecks(key, iv, tag);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    // setup cipher\n    cipher = GCM.createDecipher({\n      key: key,\n      iv: iv,\n      additionalData: adata,\n      tag: tag\n    });\n    // plaintext is the same length as ciphertext\n    pdata = Buffer.alloc(cdata.length);\n\n    var promise = new Promise(function(resolve, reject) {\n      var amt = CONSTANTS.CHUNK_SIZE,\n          plen = 0,\n          coff = 0;\n\n      (function doChunk() {\n        var clen = Math.min(amt, cdata.length - coff);\n        plen += cipher.update(cdata,\n                              coff,\n                              clen,\n                              pdata,\n                              plen);\n        coff += clen;\n        if (cdata.length > coff) {\n          setTimeout(doChunk, 0);\n          return;\n        }\n\n        try {\n          plen += cipher.finish(pdata, plen);\n        } catch (err) {\n          reject(new Error(\"decryption failed\"));\n          return;\n        }\n\n        if (plen !== cdata.length) {\n          reject(new Error(\"decryption failed\"));\n          return;\n        }\n\n        // resolve with output\n        resolve(pdata);\n      })();\n    });\n\n    return promise;\n  };\n\n  // ### WebCryptoAPI implementation\n  // TODO: cache CryptoKey sooner\n  var webcrypto = function(key, cdata, props) {\n    var adata = props.aad || props.adata || Buffer.alloc(0),\n        iv = props.iv || Buffer.alloc(0),\n        tag = props.tag || props.mac || Buffer.alloc(0);\n\n    // validate inputs\n    try {\n      commonChecks(key, iv, tag);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    var alg = {\n      name: \"AES-GCM\"\n    };\n    var promise;\n    promise = helpers.subtleCrypto.importKey(\"raw\", key, alg, true, [\"decrypt\"]);\n    promise = promise.then(function(key) {\n      alg.iv = iv;\n      alg.tagLength = 128;\n      if (adata.length) {\n        alg.additionalData = adata;\n      }\n\n      // concatenate cdata and tag\n      cdata = Buffer.concat([cdata, tag], cdata.length + tag.length);\n\n      return helpers.subtleCrypto.decrypt(alg, key, cdata);\n    });\n    promise = promise.then(function(pdata) {\n      pdata = Buffer.from(pdata);\n      return pdata;\n    });\n\n    return promise;\n  };\n\n  var nodejs = function(key, cdata, props) {\n    var adata = props.aad || props.adata || Buffer.alloc(0),\n        iv = props.iv || Buffer.alloc(0),\n        tag = props.tag || props.mac || Buffer.alloc(0);\n\n    // validate inputs\n    try {\n      commonChecks(key, iv, tag);\n    } catch (err) {\n      return Promise.reject(err);\n    }\n\n    var alg = \"aes-\" + (key.length * 8) + \"-gcm\";\n    var cipher;\n    try {\n      cipher = helpers.nodeCrypto.createDecipheriv(alg, key, iv);\n    } catch(err) {\n      throw new Error(\"unsupported algorithm: \" + alg);\n    }\n    if (\"function\" !== typeof cipher.setAAD) {\n      throw new Error(\"unsupported algorithm: \" + alg);\n    }\n    cipher.setAuthTag(tag);\n    if (adata.length) {\n      cipher.setAAD(adata);\n    }\n\n    try {\n      var pdata = Buffer.concat([\n        cipher.update(cdata),\n        cipher.final()\n      ]);\n\n      return pdata;\n    } catch (err) {\n      throw new Error(\"decryption failed\");\n    }\n  };\n\n  return helpers.setupFallback(nodejs, webcrypto, fallback);\n}\n\n// ### Public API\n// * [name].encrypt\n// * [name].decrypt\nvar aesGcm = {};\n[\n  \"A128GCM\",\n  \"A192GCM\",\n  \"A256GCM\",\n  \"A128GCMKW\",\n  \"A192GCMKW\",\n  \"A256GCMKW\"\n].forEach(function(alg) {\n  var parts = /A(\\d+)GCM(KW)?/g.exec(alg);\n  var size = parseInt(parts[1]);\n  var wrap = (parts[2] === \"KW\");\n  aesGcm[alg] = {\n    encrypt: gcmEncryptFN(size, wrap),\n    decrypt: gcmDecryptFN(size, wrap)\n  };\n});\n\nmodule.exports = aesGcm;\n"]},"metadata":{},"sourceType":"script"}